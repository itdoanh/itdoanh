<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Code Project Editor ‚Äî JSON bundle (no DB)</title>
  <style>
    :root { --bg:#0f1220; --panel:#171a2b; --text:#e8eaf2; --muted:#a9aec4; --brand:#6ea8fe; --danger:#ff6b6b; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text);}  
    header { display:flex; gap:.75rem; align-items:center; padding:12px 16px; background:linear-gradient(90deg, #10142a, #131737); position:sticky; top:0; z-index:3; border-bottom:1px solid #202545; }
    header h1 { font-size:16px; margin:0; font-weight:700; letter-spacing:.2px; }
    header input[type="text"]{ background:#0e1226; border:1px solid #243; color:var(--text); padding:8px 10px; border-radius:10px; width:220px; }
    .btn { border:1px solid #2a315f; background:#1a1f3a; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; transition:.15s; }
    .btn:hover{ background:#242a51; }
    .btn.primary{ border-color:#2f58ff44; background:#2031a8; }
    .btn.primary:hover{ background:#2a3bca; }
    .btn.danger{ border-color:#ff6b6b44; background:#5b1f2a; }
    .btn.danger:hover{ background:#7a2531; }

    .wrap{ display:grid; grid-template-columns: 280px 1fr; height: calc(100vh - 60px); }
    aside{ border-right:1px solid #202545; background:var(--panel); overflow:auto; }
    .toolbar{ display:flex; gap:.5rem; padding:10px 12px; border-bottom:1px solid #202545; position:sticky; top:0; background:var(--panel); z-index:2; }
    .filelist{ padding:8px; display:flex; flex-direction:column; gap:6px; }
    .file{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border:1px solid #22284c; border-radius:10px; background:#12162b; cursor:pointer; }
    .file.active{ outline:2px solid #3b51f6; background:#141a3a; }
    .file .name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .tags{ color:var(--muted); font-size:12px; }

    main{ display:grid; grid-template-rows: auto 1fr auto; min-width:0; }
    .meta{ display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid #202545; background:var(--panel); }
    .meta .path{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0c1022; border:1px solid #1f2547; padding:6px 10px; border-radius:8px; }
    #editor{ width:100%; height: calc(100vh - 200px); }
    #editor_fallback{ width:100%; height: calc(100vh - 200px); background:#0b1120; color:#e6edf3; border:none; padding:12px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:14px; line-height:1.5; outline:none; resize:none }
    footer{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid #202545; background:#0d1022; }
    .chip{ font-size:12px; color:var(--muted); }
    input[type="file"]{ display:none; }
    .logpane{ background:#0b1120; border-top:1px solid #202545; height:120px; overflow:auto; font-family:ui-monospace, Menlo, Consolas, monospace; padding:8px 10px; display:none; white-space:pre-wrap; }
  </style>
</head>
<body>
  <header>
    <h1>üõ†Ô∏è Code Project Editor</h1>
    <input id="projectName" type="text" placeholder="T√™n project (vd: my-app)" />
    <button class="btn" id="btnNew">+ File</button>
    <button class="btn" id="btnRename">ƒê·ªïi t√™n</button>
    <button class="btn danger" id="btnDelete">Xo√° file</button>
    <span style="flex:1"></span>
    <label class="btn" for="importInput">üì• N·∫°p g√≥i (.json)</label>
    <input id="importInput" type="file" accept="application/json" />
    <button class="btn primary" id="btnExport">üì¶ Xu·∫•t g√≥i .json</button>
  </header>

  <div class="wrap">
    <aside>
      <div class="toolbar">
        <input id="search" class="btn" style="width:100%" placeholder="T√¨m file..." />
      </div>
      <div id="fileList" class="filelist"></div>
    </aside>
    <main>
      <div class="meta">
        <span class="chip">ƒêang s·ª≠a:</span>
        <span id="currentPath" class="path">(ch∆∞a c√≥ file)</span>
        <span class="chip" id="langChip"></span>
      </div>
      <div id="editor"></div>
      <footer>
        <span class="chip" id="status">S·∫µn s√†ng.</span>
        <div style="display:flex; gap:.5rem; align-items:center;">
          <button class="btn" id="toggleLog">Chi ti·∫øt l·ªói</button>
          <span class="chip">Ace s·∫Ω t·ª± n·∫°p ‚Ä¢ L·ªói s·∫Ω hi·ªán ·ªü ƒë√¢y & console</span>
        </div>
      </footer>
      <div id="logPane" class="logpane"></div>
    </main>
  </div>

<script>
(function(){
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const fileListEl = $('#fileList');
  const editorWrap = $('#editor');
  const projectNameEl = $('#projectName');
  const currentPathEl = $('#currentPath');
  const langChipEl = $('#langChip');
  const statusEl = $('#status');
  const logPane = $('#logPane');

  const logs = [];
  function log(msg, type='info'){
    const t = `[${new Date().toLocaleTimeString()}][${type}] ${msg}`;
    logs.push(t);
    if(logPane) logPane.textContent = logs.slice(-200).join('\n');
    if(statusEl && type!=='debug') statusEl.textContent = msg;
    try{ (console[type]||console.log)(msg); }catch{ console.log(msg); }
  }
  $('#toggleLog').addEventListener('click', ()=>{
    logPane.style.display = (logPane.style.display==='block'?'none':'block');
  });
  window.addEventListener('error', e=> log(`${e.message} @ ${e.filename}:${e.lineno}`, 'error'));
  window.addEventListener('unhandledrejection', e=> log(`Promise rejection: ${e.reason}`, 'error'));

  function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s=document.createElement('script'); s.src=src; s.async=true;
      s.onload=()=>resolve(src); s.onerror=()=>reject(new Error('Fail '+src));
      document.head.appendChild(s);
    });
  }

  // Fallback: n·∫øu Ace l·ªói, d√πng textarea
  let editor=null, modelist=null, fallback=false;
  function ensureEditor(){
    if(!fallback && window.ace && !editor){
      editor = ace.edit(editorWrap);
      editor.setTheme('ace/theme/one_dark');
      editor.setOptions({ fontSize:'14px', showPrintMargin:false, enableBasicAutocompletion:true, enableSnippets:true, enableLiveAutocompletion:true });
      return;
    }
    if(!window.ace && !fallback){
      fallback = true;
      editorWrap.innerHTML = '<textarea id="editor_fallback" placeholder="// N·ªôi dung file..."></textarea>';
    }
  }
  function setEditorContent(v){ if(fallback){ $('#editor_fallback').value = v||''; } else { editor.setValue(v||'', -1); } }
  function getEditorContent(){ return fallback ? ($('#editor_fallback').value||'') : editor.getValue(); }
  function setEditorModeByLang(lang){ if(fallback) return; try{ editor.session.setMode(`ace/mode/${lang}`); }catch{ editor.session.setMode('ace/mode/text'); } }

  async function ensureAce(){
    if(window.ace) return true;
    try{
      await loadScript('https://cdn.jsdelivr.net/npm/ace-builds@1.43.3/src-min-noconflict/ace.js');
      await loadScript('https://cdn.jsdelivr.net/npm/ace-builds@1.43.3/src-min-noconflict/ext-language_tools.js');
      await loadScript('https://cdn.jsdelivr.net/npm/ace-builds@1.43.3/src-min-noconflict/ext-modelist.js');
      ace.config.set('basePath','https://cdn.jsdelivr.net/npm/ace-builds@1.43.3/src-min-noconflict');
      log('Ace loaded from jsDelivr');
      return true;
    }catch(e){
      log('jsDelivr failed, trying unpkg...', 'error');
      try{
        await loadScript('https://unpkg.com/ace-builds@1.43.3/src-min-noconflict/ace.js');
        await loadScript('https://unpkg.com/ace-builds@1.43.3/src-min-noconflict/ext-language_tools.js');
        await loadScript('https://unpkg.com/ace-builds@1.43.3/src-min-noconflict/ext-modelist.js');
        ace.config.set('basePath','https://unpkg.com/ace-builds@1.43.3/src-min-noconflict');
        log('Ace loaded from unpkg');
        return true;
      }catch(err){
        log('All CDNs failed. Using textarea fallback.', 'error');
        return false;
      }
    }
  }

  const state = { projectName:'my-project', files:[], current:-1 };
  function guessLang(name){
    const m = (name||'').toLowerCase().match(/\.([a-z0-9]+)$/);
    const ext = m? m[1] : '';
    switch(ext){
      case 'js': case 'mjs': case 'cjs': return 'javascript';
      case 'ts': case 'tsx': return 'javascript';
      case 'html': case 'htm': case 'xml': return 'xml';
      case 'css': return 'css';
      case 'json': return 'json';
      case 'py': return 'python';
      case 'cs': case 'csx': case 'cake': return 'csharp';
      case 'php': case 'phtml': case 'php5': return 'php';
      default: return '';
    }
  }

  function renderList(filter=''){
    fileListEl.innerHTML = '';
    const needle = filter.toLowerCase();
    state.files.forEach((f,i)=>{
      if(needle && !f.name.toLowerCase().includes(needle)) return;
      const row = document.createElement('div'); row.className = 'file'+(i===state.current?' active':'');
      const name = document.createElement('div'); name.className='name'; name.textContent = f.name;
      const tag = document.createElement('div'); tag.className='tags'; tag.textContent = f.language||'';
      row.appendChild(name); row.appendChild(tag);
      row.addEventListener('click', ()=> selectFile(i));
      fileListEl.appendChild(row);
    });
  }

  function selectFile(i){
    if(i<0 || i>=state.files.length) return;
    if(state.current>=0){ state.files[state.current].content = getEditorContent(); }
    state.current = i;
    const f = state.files[i];
    currentPathEl.textContent = f.name;
    langChipEl.textContent = f.language ? `lang: ${f.language}` : '';
    setEditorModeByLang(f.language||'text');
    setEditorContent(f.content||'');
    renderList($('#search').value);
  }

  function addFile(){
    let name = prompt('T√™n file m·ªõi (vd: index.html, main.js, styles.css, Program.cs):','index.html');
    if(!name) return; if(state.files.some(f=>f.name===name)) return alert('Tr√πng t√™n file.');
    const language = guessLang(name);
    state.files.push({name, language, content:''});
    selectFile(state.files.length-1);
  }
  function renameFile(){
    if(state.current<0) return; const cur = state.files[state.current];
    const next = prompt('ƒê·ªïi t√™n file th√†nh:', cur.name);
    if(!next || next===cur.name) return; if(state.files.some(f=>f.name===next)) return alert('T√™n ƒë√£ t·ªìn t·∫°i.');
    cur.name = next; cur.language = guessLang(next);
    selectFile(state.current);
  }
  function deleteFile(){
    if(state.current<0) return; const cur = state.files[state.current];
    if(!confirm('Xo√° file "'+cur.name+'"?')) return;
    state.files.splice(state.current,1);
    state.current = Math.min(state.current, state.files.length-1);
    if(state.current>=0) selectFile(state.current);
    else { setEditorContent(''); currentPathEl.textContent='(ch∆∞a c√≥ file)'; langChipEl.textContent=''; }
  }
  function exportJson(){
    if(state.current>=0){ state.files[state.current].content = getEditorContent(); }
    const project = { projectName: projectNameEl.value.trim() || state.projectName, generatedAt: new Date().toISOString(), files: state.files };
    const blob = new Blob([JSON.stringify(project,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    const safe = (project.projectName||'project').replace(/[^a-z0-9-_]/gi,'-');
    a.download = `${safe}.codeproject.json`; a.href = URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href);
    log('ƒê√£ xu·∫•t g√≥i .json');
  }
  function importJsonFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(!Array.isArray(data.files)) throw new Error('Sai ƒë·ªãnh d·∫°ng: thi·∫øu files[]');
        state.files = data.files.map(f=>({ name:f.name, language:(f.language||guessLang(f.name)), content:(f.content||'') }));
        state.projectName = data.projectName || 'imported-project'; projectNameEl.value = state.projectName;
        selectFile(0); renderList(); log('ƒê√£ n·∫°p g√≥i JSON.');
      }catch(e){ alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c JSON: '+ e.message); }
    };
    reader.readAsText(file);
  }

  // S·ª± ki·ªán
  $('#btnNew').addEventListener('click', addFile);
  $('#btnRename').addEventListener('click', renameFile);
  $('#btnDelete').addEventListener('click', deleteFile);
  $('#btnExport').addEventListener('click', exportJson);
  $('#importInput').addEventListener('change', (e)=>{ if(e.target.files[0]) importJsonFile(e.target.files[0]); e.target.value=''; });
  $('#search').addEventListener('input', e=> renderList(e.target.value));
  projectNameEl.addEventListener('input', e=> state.projectName = e.target.value);

  (async ()=>{
    const ok = await ensureAce();
    if(ok){ modelist = ace.require('ace/ext/modelist'); ensureEditor(); editor.session.on('change', ()=>{ if(state.current>=0){ statusEl.textContent='ƒê√£ thay ƒë·ªïi (ch∆∞a xu·∫•t)'; } }); }
    else { ensureEditor(); $('#editor_fallback').addEventListener('input', ()=>{ if(state.current>=0){ statusEl.textContent='ƒê√£ thay ƒë·ªïi (ch∆∞a xu·∫•t)'; } }); }

    // seed sample (d√πng \n, kh√¥ng xu·ªëng d√≤ng th·∫≠t)
    state.files = [
      {name:'index.html', language:'html', content:'<!doctype html>\n<html>\n  <head><meta charset="utf-8"><title>Hello</title></head>\n  <body>Xin ch√†o!</body>\n</html>'},
      {name:'main.js', language:'javascript', content:'console.log("Hello world")'},
      {name:'styles.css', language:'css', content:'body{font-family:sans-serif;}'},
      {name:'Program.cs', language:'csharp', content:'using System;\nclass P { static void Main(){ Console.WriteLine("Xin ch√†o C#"); } }'}
    ];
    projectNameEl.value = state.projectName;
    selectFile(0); renderList();
  })();
})();
</script>
</body>
</html>
